/*!
 * searchahead v1.0.1: Bootstrap only typeahead replacement
 * (c) 2018 Callum Fleming
 * MIT License
 * https://github.com/howzitcal/searchahead
 */


var searchahead=function(el,settings){this.text_element=document.querySelector(el);this.text_element.style.position="relative";this.text_element.setAttribute("spellcheck","false");this.text_element.setAttribute("autocomplete","off");this.text_element.style.backgroundColor="#ffffff00";this.parent_node=this.text_element.parentNode;this.under_text=document.createElement("input");this.under_text.setAttribute("tabIndex","-1");this.under_text.setAttribute("readonly","true");this.under_text.setAttribute("class","form-control");this.under_text.style.position="absolute";this.under_text.style.backgroundColor="#ffffff00";this.under_text.style.color="#ccd6dd";this.input_holder=document.createElement("div");this.input_holder.style.position="relative";this.input_holder.appendChild(this.under_text);this.input_holder.appendChild(this.text_element);this.parent_node.appendChild(this.input_holder);this.settings=settings;this.init()};searchahead.prototype={init:function(){if(this.settings.hasOwnProperty('local')&&this.settings.hasOwnProperty('remote')){this.throwError('you have defined too many resources, pick either "local" or "remote"')}
else{this.deployListeners()}},throwError:function(error){alert(`an issue has been detected in searchahead(#${this.text_element.id}) please see console.`)
console.error(`searchahead(#${this.text_element.id}) error: ${error}`)},createDropdown:function(list){var root=this;if(list.length>0){root.dropdown=document.createElement("DIV");root.dropdown.setAttribute('class','dropdown show');root.dropdown_menu=document.createElement("DIV");root.dropdown_menu.setAttribute("class","dropdown-menu show");root.dropdown_menu.style.width="100%";list.forEach(function(val,key){d_link=document.createElement("A");d_link.setAttribute("class","dropdown-item");d_link.setAttribute("href","#");d_link.onclick=function(e){root.clickedOption(e)};d_link.innerText=val.origional;root.dropdown_menu.appendChild(d_link)});this.dropdownCount=root.dropdown_menu.childNodes.length;this.dropdown.appendChild(this.dropdown_menu);this.parent_node.appendChild(this.dropdown);this.userTypeCheck();this.dropdown.onmouseover=function(){root.dropdownLevel=0;root.clearAciveDropDownState();root.text_element.value=root.typed;root.generateSuggestion(root.typed,root.resultObj)}}},clearDropdown:function(){if(this.hasOwnProperty('dropdownLevel')){this.dropdownLevel=-1}
this.parent_node.childNodes.forEach(function(val,key){if(val.classList!==undefined){if(val.classList.contains("dropdown")){val.remove()}}})},deployListeners:function(){var root=this;this.text_element.oninput=function(){root.clearDropdown();root.clearSuggestion();root.generateList(this.value);root.typed=this.value}
this.text_element.onblur=function(){var hovered=document.querySelectorAll(":hover");if(hovered[hovered.length-1].classList[0]!=='dropdown-item'){root.clearDropdown()}}
this.text_element.onfocus=function(){root.generateList(this.value)}
this.text_element.onkeydown=function(ev){if(ev.keyCode==9){if((root.text_element.value>0)&&(root.under_text.value==0)){ev.preventDefault()}
root.acceptSuggestion()}
if(ev.keyCode==40){ev.preventDefault();root.toggleDropDown("down")}
if(ev.keyCode==38){ev.preventDefault();root.toggleDropDown("up")}
if(ev.keyCode==13){root.clearDropdown()}}},generateList:function(user_input){if(this.settings.hasOwnProperty('minLength')&&(user_input.length>=this.settings.minLength)){var root=this;if(this.settings.hasOwnProperty('local')){var includes_str=this.defaultSort(user_input,this.settings.local);this.generateSuggestion(user_input,includes_str[0]);this.createDropdown(includes_str)}
else if(this.settings.hasOwnProperty('remote')){fetch(String(this.settings.remote).replace("%TERM",user_input)).then(response=>response.json()).then(function(json_response){var includes_str=root.defaultSort(user_input,json_response);root.generateSuggestion(user_input,includes_str[0]);root.createDropdown(includes_str)})}
else{this.throwError('No data source created!, define local or remote')}}},clickedOption:function(el){this.text_element.value=el.target.innerText;this.clearDropdown();this.clearSuggestion()},generateSuggestion:function(suggestion,resultObj){this.clearSuggestion();var user_input=this.text_element.value;suggestion=(suggestion!==undefined)?suggestion:"";if(user_input.length>0&&resultObj!==undefined){sliced_origional=resultObj.origional.substring(suggestion.length,resultObj.origional.length);sliced_user=suggestion.substring(0,suggestion.length);this.under_text.setAttribute("value",sliced_user+sliced_origional);this.resultObj=resultObj}
else{this.clearSuggestion()}},clearSuggestion:function(){if(this.under_text){this.under_text.setAttribute("value","")}},acceptSuggestion:function(){if(this.under_text.value.length>0){this.text_element.value=this.resultObj.origional}
this.clearDropdown();this.clearSuggestion()},defaultSort:function(item,arr){var final_array=[]
var results=[];item=item.toLowerCase();arr.forEach(function(val,key){final_array.push({'val':val.toLowerCase(),'origional':val,'key':key})});final_array.forEach(function(v){if(v.val.slice(0,item.length)==item){results.push(v)}});return results},userTypeCheck:function(){if(this.dropdown_menu.childElementCount==1){if(this.dropdown_menu.firstChild.innerText.toLowerCase()==this.text_element.value.toLowerCase()){this.text_element.value=this.dropdown_menu.firstChild.innerText;this.clearSuggestion();this.clearDropdown()}}},toggleDropDown:function(direction){this.clearSuggestion();if(!this.hasOwnProperty('dropdownLevel')){this.dropdownLevel=0;this.actionDropDownMove()}
else if(direction=="up"&&(this.dropdownLevel-1)>=-1){this.dropdownLevel-=1;this.actionDropDownMove()}
else if(direction=="down"&&(this.dropdownLevel+1)<this.dropdownCount){this.dropdownLevel+=1;this.actionDropDownMove()}},actionDropDownMove:function(){this.clearAciveDropDownState();if(this.dropdownLevel!=-1&&this.dropdownLevel<=this.dropdownCount){var d_link=this.dropdown_menu.childNodes[this.dropdownLevel];d_link.classList.add("active");this.text_element.value=d_link.innerText}
else{this.text_element.value=this.typed;this.generateSuggestion(this.typed,this.resultObj)}},clearAciveDropDownState:function(){this.dropdown_menu.childNodes.forEach(function(val){val.classList.remove("active")})}}
